<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä¸šæœºå™¨äººå®‰å…¨ç›‘æ§ Pro</title>
    <style>
        :root { --bg-color: #121212; --panel-color: #1e1e24; --text-color: #e0e0e0; --accent-color: #4cc9f0; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; transition: background 0.5s; min-height: 100vh; }
        
        /* çŠ¶æ€èƒŒæ™¯è‰² */
        body.warn { background-color: #332b00; }
        body.stop { background-color: #2a0a0a; }
        
        .container { background: var(--panel-color); padding: 20px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.6); margin-top: 20px; width: 90%; max-width: 550px; border: 1px solid #333; }
        
        /* --- è§†é¢‘èˆå° --- */
        .video-stage { height: 240px; margin: 20px 0; background: #000; border-radius: 15px; overflow: hidden; border: 2px solid rgba(255,255,255,0.1); position: relative; }
        
        /* è§†é¢‘æ··åˆæ¨¡å¼ (æŠ å›¾æ•ˆæœ) */
        #robot-video { width: 100%; height: 100%; object-fit: cover; mix-blend-mode: screen; filter: brightness(0.9) contrast(1.1); transition: opacity 0.3s; }
        
        /* --- æŠ¥è­¦é®ç½© (å¤§å›¾æ ‡) --- */
        #alarm-overlay { position: absolute; top:0; left:0; width:100%; height:100%; display: flex; justify-content: center; align-items: center; pointer-events: none; z-index: 10; }
        .alarm-icon { font-size: 5rem; display: none; animation: pulse 0.8s infinite alternate; text-shadow: 0 0 20px currentColor; }
        body.warn .alarm-icon#icon-warn { display: block; color: #ffd700; }
        body.stop .alarm-icon#icon-stop { display: block; color: #ff4444; }
        @keyframes pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.1); opacity: 1; } }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .control-panel { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid #444; }
        .control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .control-row label { font-size: 0.9rem; color: #aaa; }
        .control-row input { background: #333; border: 1px solid #555; color: white; padding: 8px; border-radius: 5px; width: 80px; text-align: center; font-size: 1rem; }
        .btn-update { width: 100%; background: #2e7d32; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-update:active { transform: scale(0.98); }
        .settings-info { text-align:center; font-size:0.8rem; color:#666; margin-top:5px; }

        /* --- è¿æ¥æŒ‰é’® --- */
        .btn-connect { background: var(--accent-color); color: #000; border: none; padding: 12px; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 20px; font-size: 1.1rem; }

        /* --- æ•°æ®æ˜¾ç¤º --- */
        .data-display { text-align: center; margin-bottom: 15px; }
        #res { font-size: 2.5rem; font-weight: bold; }
        
        /* --- æ—¥å¿—é¢æ¿ (æ¢å¤å›æ¥äº†ï¼) --- */
        .log-panel { background: #0a0a10; border: 1px solid #333; border-radius: 10px; padding: 10px; height: 150px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.85rem; text-align: left; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); margin-top: 15px; }
        .log-entry { margin-bottom: 4px; border-left: 3px solid #444; padding-left: 8px; }
        .log-time { color: #555; margin-right: 8px; font-size: 0.75rem; }
        .log-type-0 { border-left-color: #4caf50; color: #a5d6a7; } /* æ­£å¸¸ */
        .log-type-1 { border-left-color: #ffd700; color: #fff59d; } /* è­¦å‘Š */
        .log-type-2 { border-left-color: #ff4444; color: #ff8a80; } /* åœæœº */

    </style>
</head>
<body class="bg-normal">
    <div class="container">
        <h3 id="title" style="text-align:center; margin-top:0;">ğŸ¤– å·¥ä¸šæœºå™¨äººä¸­æ§å°</h3>
        
        <div class="video-stage">
            <video id="robot-video" src="C:\Users\thepainter\Desktop\project\high T pro\html\robot_arm\robot_arm.mp4" loop muted playsinline></video>
            
            <div id="alarm-overlay">
                <div id="icon-warn" class="alarm-icon">âš ï¸</div>
                <div id="icon-stop" class="alarm-icon">ğŸ›‘</div>
            </div>
        </div>

        <div class="data-display">
            é˜»æŠ—: <span id="res">0.00</span> MÎ©
        </div>

        <div class="control-panel">
            <div class="control-row">
                <label>âš ï¸ è­¦å‘Šé˜ˆå€¼ (ADC)</label>
                <input type="number" id="input-warn" value="300">
            </div>
            <div class="control-row">
                <label>ğŸ›‘ åœæœºé˜ˆå€¼ (ADC)</label>
                <input type="number" id="input-stop" value="800">
            </div>
            <button class="btn-update" onclick="sendThresholds()">ğŸ“¤ æ›´æ–°è®¾ç½®åˆ°ç³»ç»Ÿ </button>
            <div class="settings-info">å½“å‰è®¾å¤‡ç”Ÿæ•ˆå€¼: <span id="current-settings">-- / --</span></div>
        </div>

        <button class="btn-connect" onclick="connectBLE()">ğŸ“¡ è¿æ¥è®¾å¤‡</button>

        <div class="log-panel">
            <div style="border-bottom:1px solid #333; margin-bottom:5px; color:#666;">ç³»ç»Ÿæ—¥å¿— / System Log</div>
            <div id="log-list"></div>
        </div>
    </div>

    <script>
        let pCharData, pCharControl;
        const robotVideo = document.getElementById('robot-video');
        let lastMode = -1; // ç”¨äºé˜²æ­¢æ—¥å¿—åˆ·å±

        // åˆå§‹åŒ–æš‚åœè§†é¢‘
        robotVideo.pause();

        async function connectBLE() {
            try {
                addLog("æ­£åœ¨æ‰«æè“ç‰™è®¾å¤‡...", 0);
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Industrial_Robot_Monitor' }],
                    optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
                });
                
                addLog(`å·²é€‰æ‹©: ${device.name}, è¿æ¥ä¸­...`, 0);
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
                
                // 1. è·å–æ•°æ®ç‰¹å¾ (Notify)
                pCharData = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
                pCharData.startNotifications();
                pCharData.addEventListener('characteristicvaluechanged', handleData);
                
                // 2. è·å–æ§åˆ¶ç‰¹å¾ (Write)
                pCharControl = await service.getCharacteristic('1c95d5e3-d8bc-4e31-9988-16c5b5f90a8f');

                document.getElementById('title').innerText = "âœ… ç³»ç»Ÿåœ¨çº¿";
                addLog("è¿æ¥æˆåŠŸï¼å¼€å§‹å®æ—¶ç›‘æ§ã€‚", 0);
                robotVideo.play().catch(e => console.log("è‡ªåŠ¨æ’­æ”¾éœ€äº¤äº’"));
                
            } catch (err) {
                addLog(`è¿æ¥å¤±è´¥: ${err.message}`, 2);
                alert("è¿æ¥å¤±è´¥: " + err);
            }
        }

        function handleData(e) {
            const raw = new TextDecoder().decode(e.target.value);
            // æ ¼å¼: "ç”µé˜»,æ¨¡å¼,è­¦å‘Šé˜ˆå€¼,åœæœºé˜ˆå€¼"
            const parts = raw.split(',');
            
            // ç®€å•çš„é˜²é”™å¤„ç†
            if(parts.length < 2) return;

            const res = parseFloat(parts[0]);
            const mode = parseInt(parts[1]);
            
            // å¦‚æœESP32ä¼ å›äº†é˜ˆå€¼è®¾ç½® (æ–°ä»£ç æ‰æœ‰)
            if(parts.length >= 4) {
                document.getElementById('current-settings').innerText = `${parts[2]} / ${parts[3]}`;
            }

            updateUI(res, mode);
        }

        function updateUI(res, mode) {
            document.getElementById('res').innerText = res.toFixed(2);
            const body = document.body;

            // çŠ¶æ€é€»è¾‘
            if(mode === 2) { // åœæœº
                body.className = "stop";
                robotVideo.pause(); // åœæœºæ—¶è§†é¢‘æš‚åœ
            } else if(mode === 1) { // è­¦å‘Š
                body.className = "warn";
                if(robotVideo.paused) robotVideo.play();
            } else { // æ­£å¸¸
                body.className = "bg-normal";
                if(robotVideo.paused) robotVideo.play();
            }

            // æ—¥å¿—é€»è¾‘ (é˜²æŠ–åŠ¨)
            if (mode !== lastMode) {
                if (mode === 2) addLog(`ğŸ›‘ è§¦å‘åœæœºä¿æŠ¤ [R:${res.toFixed(1)}MÎ©]`, 2);
                else if (mode === 1) addLog(`âš ï¸ æ¸©åº¦è¶Šé™è­¦å‘Š [R:${res.toFixed(1)}MÎ©]`, 1);
                else if (mode === 0 && lastMode !== -1) addLog(`ğŸŸ¢ æ¢å¤æ­£å¸¸è¿è¡Œ [R:${res.toFixed(1)}MÎ©]`, 0);
                lastMode = mode;
            }
        }

        async function sendThresholds() {
            if(!pCharControl) { alert("è¯·å…ˆè¿æ¥è“ç‰™ï¼"); return; }
            
            const warnVal = document.getElementById('input-warn').value;
            const stopVal = document.getElementById('input-stop').value;
            const cmd = `${warnVal},${stopVal}`;
            
            try {
                const encoder = new TextEncoder();
                await pCharControl.writeValue(encoder.encode(cmd));
                addLog(`ğŸ“¤ å‘é€æ–°é˜ˆå€¼: è­¦å‘Š${warnVal} / åœæœº${stopVal}`, 0);
                alert("è®¾ç½®å·²å‘é€ï¼");
            } catch(e) {
                addLog(`å‘é€å¤±è´¥: ${e.message}`, 2);
            }
        }

        // æ·»åŠ æ—¥å¿—å‡½æ•°
        function addLog(message, type) {
            const list = document.getElementById('log-list');
            const entry = document.createElement('div');
            entry.className = `log-entry log-type-${type}`;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
            
            entry.innerHTML = `<span class="log-time">${timeStr}</span>${message}`;
            list.insertBefore(entry, list.firstChild); // æœ€æ–°æ—¥å¿—åœ¨æœ€ä¸Šé¢
        }
    </script>
</body>

</html>
